<!doctype html><html dir=auto lang=en><head><meta charset=utf-8><meta content="IE=edge" http-equiv=X-UA-Compatible><meta content="width=device-width,initial-scale=1,shrink-to-fit=no" name=viewport><meta content="index, follow" name=robots><title>SRI Full Stack or: How I Learned to Stop Worrying and Love Testnet4</title><meta content="keyword1, keyword2, keyword3" name=keywords><meta name=description><meta content=vnprc name=author><link href=https://hashpool.dev/dev-logs/dev-log-2024-09-15/ rel=canonical><link href=https://hashpool.dev/css/includes/scroll-bar.css rel=stylesheet><link href=https://hashpool.dev/css/styles.css rel=stylesheet><link href=https://hashpool.dev/css/override.css rel=stylesheet><link href=https://hashpool.dev/atom.xml rel=alternate title=RSS type=application/atom+xml><noscript><style>#theme-toggle,.top-link{display:none}</style> <style>@media (prefers-color-scheme:dark){:root{--theme:#1d1e20;--entry:#2e2e33;--primary:#dadadb;--secondary:#9b9c9d;--tertiary:#414244;--content:#c4c4c5;--hljs-bg:#2e2e33;--code-bg:#37383e;--border:#333}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><body id=top><script>if(localStorage.getItem(`pref-theme`)===`dark`){document.body.classList.add(`dark`)}else if(localStorage.getItem(`pref-theme`)===`light`){document.body.classList.remove(`dark`)}else if(window.matchMedia(`(prefers-color-scheme: dark)`).matches){document.body.classList.add(`dark`)}</script><header class=header><nav class=nav><div class=logo><a title="Hashpool (Alt + H)" accesskey=h href=https://hashpool.dev> Hashpool </a><div class=logo-switches><button title="(Alt + T)" accesskey=t id=theme-toggle><svg viewbox="0 0 24 24" fill=none height=18 id=moon stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg> <svg viewbox="0 0 24 24" fill=none height=18 id=sun stroke=currentColor stroke-linecap=round stroke-linejoin=round stroke-width=2 width=24 xmlns=http://www.w3.org/2000/svg><circle cx=12 cy=12 r=5></circle><line x1=12 x2=12 y1=1 y2=3></line><line x1=12 x2=12 y1=21 y2=23></line><line x1=4.22 x2=5.64 y1=4.22 y2=5.64></line><line x1=18.36 x2=19.78 y1=18.36 y2=19.78></line><line x1=1 x2=3 y1=12 y2=12></line><line x1=21 x2=23 y1=12 y2=12></line><line x1=4.22 x2=5.64 y1=19.78 y2=18.36></line><line x1=18.36 x2=19.78 y1=5.64 y2=4.22></line></svg></button><ul class=lang-switch><li></ul></div></div><ul id=menu><li><a href=https://hashpool.dev title=About> <span>About</span> </a><li><a title="Development Logs" href=https://hashpool.dev/dev-logs> <span>Development Logs</span> </a><li><a href=https://hashpool.dev/search title=Search> <span>Search</span> </a><li><a href=https://github.com/vnprc/hashpool title=Github> <span>Github</span> </a></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://hashpool.dev>Home</a> »  <a href=https://hashpool.dev/dev-logs/>Developer Logs</a> »  <a href=https://hashpool.dev/dev-logs/dev-log-2024-09-15/>SRI Full Stack or: How I Learned to Stop Worrying and Love Testnet4</a></div><h1 class=post-title>SRI Full Stack or: How I Learned to Stop Worrying and Love Testnet4</h1><div class=post-meta><span title="2024-09-15 00:00:00 +0000">2024-09-15</span> · 4 min · vnprc</div></header><div class=post-content><p>I made good progress this week:<ul><li>switched from the hosted template provider to running my own full stack <ul><li>this required me to spin up a testnet4 bitcoin node</ul><li>added a cashu mint to the pool role<li>added <code>keyset_id</code> field to the SetupConnectionSuccess struct <ul><li>more importantly, I learned why this approach won't work and what approach will</ul></ul><p>In order to get off of the hosted template provider I simply followed the instructions in the "Running all Roles" section of the <a href=https://stratumprotocol.org/getting-started/#ii-getting-started---running-all-roles>guide</a>. The Stratum v2 documentation and project maturity has been super helpful. It would be very hard to get a project like this off the ground if I wasn't able to stand on the shoulders of these giants.<p>I spun up a testnet4 node using Sjors' fork. It worked like a charm. Testnet4 is being added to the next major bitcoind release so I might want to switch over if I begin having issues with my node, but so far so good.<p>I added a cashu mint to the pool role using cdk. At this point it didn't do anything but just getting it to compile and run was further than I got with moksha. No dependency issues, yay!<p>I took some time to explore the stratum codebase and cashu protocol more deeply and work out a plan for how to generate the keyset and pass it to the client side. I decided to add a keyset_id field to the SetupConnectionSuccess message struct. The keyset ID is the one piece of information the wallet needs to produce valid blinded signatures. Normally, a collection of keyset IDs is used by the wallet software to generate different denominations of ecash but a single one will do for my purposes. At this stage, I'm just showing what is possible and scouting the path ahead.<p>It took another day to understand the stratum plumbing enough to pass the message along from pool instantiation to the SetupConnectionSuccess message. Once I appeased all of the rust compiler's demands I started it up to kick the tires and found a nice error:<pre style=color:#c0c5ce;background-color:#2b303b><code><span>2024-09-13T02:59:39.897045Z INFO pool_sv2::lib::template_receiver: Connected to template distribution server at 127.0.0.1:8442 
</span><span>2024-09-13T02:59:40.011559Z ERROR pool_sv2::lib: Could not connect to Template Provider: Roles Logic SV2 error: `BinarySv2Error(DecodableConversionError)` 2024-09-13T02:59:40.011581Z ERROR network_helpers_sv2::noise_connection_tokio: Disconnecting from client due to error receiving: receiving from an empty and closed channel - 127.0.0.1:8442
</span></code></pre><p>Something in the stack didn't appreciate that I had changed the message format! A little more digging revealed that bitcoind was listening on localhost:8442. I don't need to modify any messages being sent to bitcoind, only messages between the pool and translator proxy. So my hacky code changes were applied more broadly than needed and this conflicted with what bitcoind was expecting.<p>Thankfully, @fi3 on the discord showed me the way: I need to write a Sv2 extension and define my own message type. Even better, @fi3 has already written one that I can use for a reference! \o/<p>Next week goals:<ul><li>refactor my branch into a Sv2 extension<li>define a new message type to be used when a translator proxy daemon connects to a pool daemon <ul><li>include <code>keyset_id</code> field</ul><li>in the translator proxy, retrieve the keyset_id from the pool and use it to produce blinded secrets<li>define a new share submission message type that includes the blinded secret<li>pool: sign the blinded message when a share submission is accepted<li>define a new share submission accepted message type that includes the blinded signature from the pool<li>proxy: unblind and store the signature in the wallet</ul><p>I'm getting a little anxious about meeting my deadline but I remain focused on forward progress. There are a few hack days built into the berlin conference so I may have a complete demo in time for TAB even if it's not working for BTC++. I calm myself with the knowledge that the deadline is artificial and self-imposed. It exists only for motivational purposes.</div><footer class=post-footer><nav class=paginav></nav></footer></article></main><footer class=footer><span>© 2025 <a href=https://github.com/vnprc>vnprc</a></span><span> Powered by <a rel="noopener noreferrer" href=https://www.getzola.org/ target=_blank>Zola</a> & <a href=https://github.com/cydave/zola-theme-papermod rel=noopener target=_blank>PaperMod</a> </span></footer><a aria-label="go to top" title="Go to Top (Alt + G)" accesskey=g class=top-link href=#top id=top-link> <svg viewbox="0 0 12 6" fill=currentColor xmlns=http://www.w3.org/2000/svg><path d="M12 6H0l6-6z"/></svg> </a><script>let menu=document.getElementById(`menu`);if(menu){let a=`menu-scroll-position`;menu.scrollLeft=localStorage.getItem(a);menu.onscroll=(()=>{localStorage.setItem(a,menu.scrollLeft)})};document.querySelectorAll(`a[href^="#"]`).forEach(a=>{let c=null,b=decodeURIComponent;a.addEventListener(`click`,function(a){a.preventDefault();var d=this.getAttribute(`href`).substr(1);if(!window.matchMedia(`(prefers-reduced-motion: reduce)`).matches){document.querySelector(`[id='${b(d)}']`).scrollIntoView({behavior:`smooth`})}else{document.querySelector(`[id='${b(d)}']`).scrollIntoView()};if(d===`top`){history.replaceState(c,c,` `)}else{history.pushState(c,c,`#${d}`)}})})</script><script>var mybutton=document.getElementById(`top-link`);window.onscroll=(()=>{let a=800;if(document.body.scrollTop>a||document.documentElement.scrollTop>a){mybutton.style.visibility=`visible`;mybutton.style.opacity=`1`}else{mybutton.style.visibility=`hidden`;mybutton.style.opacity=`0`}})</script><script>document.getElementById(`theme-toggle`).addEventListener(`click`,()=>{let a=`dark`,b=`pref-theme`;if(document.body.className.includes(a)){document.body.classList.remove(a);localStorage.setItem(b,`light`)}else{document.body.classList.add(a);localStorage.setItem(b,a)}})</script><script>document.querySelectorAll(`pre > code`).forEach(a=>{let f=`TABLE`,e=`copy`;var d=(()=>{c.innerText=`copied!`;setTimeout(()=>{c.innerText=e},2000)});const b=a.parentNode.parentNode;const c=document.createElement(`button`);c.classList.add(`copy-code`);c.innerText=e;c.addEventListener(`click`,b=>{if(`clipboard` in navigator){var c=a.textContent;if(a.firstChild.tagName==f){c=Array(...a.firstChild.getElementsByTagName(`span`)).map(a=>a.textContent).join(``)};navigator.clipboard.writeText(c);d();return};const g=document.createRange();g.selectNodeContents(a);const h=window.getSelection();h.removeAllRanges();h.addRange(g);try{document.execCommand(e);d()}catch(a){}h.removeRange(g)});if(b.classList.contains(`highlight`)){b.appendChild(c)}else if(b.parentNode.firstChild==b){}else if(a.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName==f){a.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(c)}else{a.parentNode.appendChild(c)}})</script>